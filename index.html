<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Etheric Double Camera — Prototype (v2 smooth)</title>
  <style>
    :root{--bg1:#1e2f3a;--bg2:#7fb6c9;--bg3:#c6b6df}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100vh;display:grid;grid-template-rows:auto 1fr auto;background:radial-gradient(140% 120% at 50% 20%, rgba(198,182,223,.45), rgba(127,182,201,.35) 35%, rgba(30,47,58,.9))}
    header{padding:16px 20px;color:#fff;text-align:center}
    header h1{margin:.2rem 0 0;font-size:1.2rem;font-weight:600;letter-spacing:.02em}
    .app{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    .stage{position:relative;max-width:820px;margin:0 auto;border-radius:18px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.35);background:#000}
    canvas, video{display:block;width:100%;height:auto}
    video{position:absolute;inset:0;opacity:0;pointer-events:none}
    .controls{max-width:820px;margin:10px auto 18px;background:rgba(255,255,255,.08);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);padding:12px 14px;border-radius:14px;color:#eef}
    .row{display:grid;grid-template-columns:160px 1fr 70px;gap:10px;align-items:center;margin:6px 0}
    input[type="range"]{width:100%}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    button{appearance:none;background:#e8e8ff;color:#222;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.sec{background:#222;color:#eaeaff;border:1px solid #666}
    footer{color:#9ec9d8;text-align:center;padding:12px;font-size:.85rem}
    .note{font-size:.8rem;color:#cfe7f1}
    a.dl{display:inline-block;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Etheric Double Camera — Prototype (v2 smooth)</h1>
      <div class="note">Sharper mask + feathered edges + higher‑res feed. Best in Chrome/Android. iPhone users: use iOS screen recorder if in‑page recording is blocked.</div>
    </header>
    <main class="app">
      <div class="stage">
        <video id="video" playsinline></video>
        <canvas id="out"></canvas>
      </div>
      <section class="controls">
        <div class="row">
          <label for="edge">Edge Feather</label>
          <input id="edge" type="range" min="0" max="8" value="3" />
          <span id="edgeVal">3px</span>
        </div>
        <div class="row">
          <label for="blur">Aura Blur</label>
          <input id="blur" type="range" min="0" max="80" value="36" />
          <span id="blurVal">36</span>
        </div>
        <div class="row">
          <label for="glow">Glow Intensity</label>
          <input id="glow" type="range" min="20" max="120" value="80" />
          <span id="glowVal">0.80</span>
        </div>
        <div class="row">
          <label for="scale">Aura Size</label>
          <input id="scale" type="range" min="0" max="12" value="3" />
          <span id="scaleVal">3%</span>
        </div>
        <div class="row">
          <label for="tint">Aura Tint</label>
          <input id="tint" type="color" value="#88d0ff" />
          <span id="tintVal">#88D0FF</span>
        </div>
        <div class="btns">
          <button id="start">Start Camera</button>
          <button id="rec" class="sec" disabled>● Start Recording</button>
          <span id="download"></span>
        </div>
      </section>
    </main>
    <footer>Tip: even front light + darker background = clean silhouette.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('out');
    const ctx = canvas.getContext('2d');

    // UI
    const edgeEl = document.getElementById('edge');
    const blurEl = document.getElementById('blur');
    const glowEl = document.getElementById('glow');
    const scaleEl = document.getElementById('scale');
    const tintEl = document.getElementById('tint');
    const edgeVal = document.getElementById('edgeVal');
    const blurVal = document.getElementById('blurVal');
    const glowVal = document.getElementById('glowVal');
    const scaleVal = document.getElementById('scaleVal');
    const tintVal = document.getElementById('tintVal');
    [edgeEl, blurEl, glowEl, scaleEl, tintEl].forEach(el=> el.addEventListener('input', updateLabels));
    function updateLabels(){
      edgeVal.textContent = edgeEl.value+"px";
      blurVal.textContent = blurEl.value;
      glowVal.textContent = (glowEl.value/100).toFixed(2);
      scaleVal.textContent = scaleEl.value+"%";
      tintVal.textContent = tintEl.value.toUpperCase();
    }
    updateLabels();

    // Offscreens
    const maskCanvas = document.createElement('canvas');
    const maskCtx = maskCanvas.getContext('2d');
    const softMaskCanvas = document.createElement('canvas');
    const softMaskCtx = softMaskCanvas.getContext('2d');
    const auraCanvas = document.createElement('canvas');
    const auraCtx = auraCanvas.getContext('2d');
    const silhouetteCanvas = document.createElement('canvas');
    const silhouetteCtx = silhouetteCanvas.getContext('2d');

    // MediaPipe setup — higher quality
    const selfieSeg = new SelfieSegmentation({locateFile: (file)=> `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfieSeg.setOptions({modelSelection: 1, selfieMode: true});
    selfieSeg.onResults(onResults);

    function onResults(results){
      if(!video.videoWidth) return;
      const w = video.videoWidth;
      const h = video.videoHeight;
      [canvas, maskCanvas, softMaskCanvas, auraCanvas, silhouetteCanvas].forEach(c=>{c.width=w; c.height=h;});

      // 1) Draw raw mask at full canvas size with smoothing, then feather
      maskCtx.imageSmoothingEnabled = true;
      maskCtx.clearRect(0,0,w,h);
      maskCtx.drawImage(results.segmentationMask, 0,0,w,h);

      // Feather edges
      softMaskCtx.clearRect(0,0,w,h);
      softMaskCtx.filter = `blur(${+edgeEl.value}px)`;
      softMaskCtx.drawImage(maskCanvas,0,0);
      softMaskCtx.filter = 'none';

      // 2) Build soft silhouette preserving gray alpha from mask
      silhouetteCtx.clearRect(0,0,w,h);
      silhouetteCtx.save();
      silhouetteCtx.drawImage(softMaskCanvas,0,0);
      silhouetteCtx.globalCompositeOperation = 'source-in';
      silhouetteCtx.fillStyle = '#ffffff';
      silhouetteCtx.fillRect(0,0,w,h);
      silhouetteCtx.restore();

      // 3) Aura pass (bigger blur + gradient)
      auraCtx.clearRect(0,0,w,h);
      auraCtx.save();
      auraCtx.filter = `blur(${+blurEl.value}px)`;
      auraCtx.globalAlpha = +glowEl.value/100;
      const scale = 1 + (+scaleEl.value/100);
      auraCtx.setTransform(scale,0,0,scale,0,0);
      auraCtx.drawImage(silhouetteCanvas,0,0);
      auraCtx.setTransform(1,0,0,1,0,0);
      auraCtx.globalCompositeOperation = 'source-in';
      const grad = auraCtx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.06,w/2,h/2,Math.max(w,h)*0.65);
      grad.addColorStop(0, tintEl.value + 'ff');
      grad.addColorStop(0.55, tintEl.value + '40');
      grad.addColorStop(1, '#ffffff00');
      auraCtx.fillStyle = grad;
      auraCtx.fillRect(0,0,w,h);
      auraCtx.restore();

      // 4) Composite background + dimmed camera + aura + silhouette
      const bg = ctx.createRadialGradient(w/2,h*0.45,Math.min(w,h)*0.1, w/2,h*0.55, Math.max(w,h)*0.85);
      bg.addColorStop(0,'rgba(255,255,255,0.55)');
      bg.addColorStop(0.5,'rgba(150, 210, 230, 0.32)');
      bg.addColorStop(1,'rgba(20, 35, 45, 1)');
      ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);

      ctx.globalAlpha = 0.12; ctx.drawImage(video,0,0,w,h); ctx.globalAlpha=1;
      ctx.drawImage(auraCanvas,0,0);
      ctx.drawImage(silhouetteCanvas,0,0);
    }

    async function start(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'user', width:{ideal:1920}, height:{ideal:1080}},
        audio:false
      });
      video.srcObject = stream; await video.play();
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      animate();
      document.getElementById('rec').disabled = false;
    }

    async function animate(){
      if(video.readyState >= 2){ await selfieSeg.send({image: video}); }
      requestAnimationFrame(animate);
    }

    // Recording
    let recorder, chunks=[]; let recording=false; let dlLink; const recBtn = document.getElementById('rec');
    function toggleRec(){
      if(!recording){
        const stream = canvas.captureStream(30);
        const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : (MediaRecorder.isTypeSupported('video/webm') ? 'video/webm' : '');
        if(!mime){ alert('In‑page recording not supported in this browser. Use your phone\'s screen recorder.'); return; }
        recorder = new MediaRecorder(stream, {mimeType: mime});
        chunks=[]; recorder.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
        recorder.onstop = ()=>{ const blob = new Blob(chunks, {type: recorder.mimeType}); const url = URL.createObjectURL(blob);
          const name = `etheric-double-${Date.now()}.webm`; const span = document.getElementById('download'); span.innerHTML='';
          const a = document.createElement('a'); a.className='dl'; a.href=url; a.download=name; a.textContent='Download video'; span.appendChild(a);
        };
        recorder.start(); recording=true; recBtn.textContent='■ Stop Recording'; recBtn.classList.remove('sec');
      } else { recorder.stop(); recording=false; recBtn.textContent='● Start Recording'; recBtn.classList.add('sec'); }
    }

    document.getElementById('start').addEventListener('click', start);
    document.getElementById('rec').addEventListener('click', toggleRec);
  </script>
</body>
</html>
